#!/usr/bin/env bash

# Pre-commit quality gates for grok-mcp

# 0. Run lint-staged (prettier + eslint auto-fix on staged files)
npx lint-staged || { echo "❌ lint-staged failed"; exit 1; }

# Parallelize independent checks
# 1. Lint
npm run lint &
LINT_PID=$!

# 2. Type check
npm run type-check &
TYPE_CHECK_PID=$!

# Wait for parallel checks; fail on first error
wait "$LINT_PID" || { echo "❌ Lint failed"; exit 1; }
wait "$TYPE_CHECK_PID" || { echo "❌ Type check failed"; exit 1; }

# 3. Run unit tests only (fast, no API calls)
npm run test:unit || { echo "❌ Unit tests failed"; exit 1; }

# 4. Check for console.log (warning only)
STAGED_TS=$(git diff --cached --name-only -- '*.ts' | grep -v '.test.' || true)
if [ -n "$STAGED_TS" ]; then
  CONSOLE_FOUND=$(echo "$STAGED_TS" | xargs grep -l 'console.log' 2>/dev/null || true)
  if [ -n "$CONSOLE_FOUND" ]; then
    echo "⚠️  console.log found in staged files:"
    echo "$CONSOLE_FOUND"
  fi
fi

# 5. Check for secrets
STAGED_FILES=$(git diff --cached --name-only || true)
if [ -n "$STAGED_FILES" ]; then
  SECRETS_FOUND=$(echo "$STAGED_FILES" | xargs grep -l -E "(password|secret|api[_-]?key|token|credential)\s*[:=]\s*['\"][^'\"]+['\"]" 2>/dev/null || true)
  if [ -n "$SECRETS_FOUND" ]; then
    echo "❌ Hardcoded secrets detected:"
    echo "$SECRETS_FOUND"
    exit 1
  fi
fi

# 6. Check for 'any' types (warning only)
STAGED_TS_ALL=$(git diff --cached --name-only -- '*.ts' | grep -v '.test.' | grep -v '.d.ts' || true)
if [ -n "$STAGED_TS_ALL" ]; then
  ANY_FOUND=$(echo "$STAGED_TS_ALL" | xargs grep -l ': any' 2>/dev/null || true)
  if [ -n "$ANY_FOUND" ]; then
    echo "⚠️  'any' type found in staged files - consider using proper types:"
    echo "$ANY_FOUND"
  fi
fi

# 7. Check test assertion density (warning for thin tests)
STAGED_TESTS=$(git diff --cached --name-only -- '*.test.ts' || true)
if [ -n "$STAGED_TESTS" ]; then
  for file in $STAGED_TESTS; do
    if [ -f "$file" ]; then
      LINES=$(wc -l < "$file" | tr -d ' ')
      EXPECTS=$(grep -c 'expect(' "$file" 2>/dev/null || echo "0")
      if [ "$LINES" -gt 50 ] && [ "$EXPECTS" -lt 3 ]; then
        echo "⚠️  Low assertion density in $file ($EXPECTS expects in $LINES lines)"
      fi
    fi
  done
fi

echo "✅ Pre-commit passed"
